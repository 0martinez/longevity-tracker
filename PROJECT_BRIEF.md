# Project Brief (Local-First Sleep & Habits Tracker) — Monorepo Plan for a Coding Agent

## 0) Goal (What we are building)
Build a **local-first** habits tracker focused on optimizing **sleep quality** by recording daily habits (nutrition, exercise, supplementation, caffeine/alcohol, etc.) and later using an **AI agent** to parse natural language entries, generate structured features, produce summaries/insights, and propose experiments.

**Key product principle:**  
- The **source of truth is local Markdown files** (human-readable, portable, editable).
- The app provides an **inbox-like natural language input** to append entries quickly.
- Derived outputs (structured features, summaries) are **rebuildable artifacts** generated from the source Markdown.

**Non-goals:**
- No commercialization, no multi-tenant auth, no cloud DB.
- Avoid heavy infrastructure. Keep everything local and simple.

---

## 1) Tech Stack (must use)
### Monorepo / Tooling
- **Turborepo** for monorepo orchestration
- **Bun** as the package manager (`bun install`, workspaces)
- **Node.js** runtime (do not run backend on Bun runtime)
- TypeScript everywhere

### Frontend
- **React + TypeScript**
- **Vite** (fast dev)

### Backend
- **Node + Express + TypeScript**
- Dev runner: **tsx**
- Middleware: **cors**, **express.json**
- Validation: **zod**
- Env: **dotenv**

### AI Layer (phase 2+)
- **Mastra** (TypeScript AI agent/workflow framework)
- Initially keep AI layer optional; start with non-AI functionality solid.
- When introduced, AI should only write into `derived/` by default (never silently rewrite source journal files).

---

## 2) Storage Model (Local Markdown + Derived Artifacts)
### Source-of-truth folder
At repository root (not inside apps):
```
data/
  journal/
    YYYY-MM-DD.md
  derived/
    YYYY-MM-DD.features.json
    YYYY-MM-DD.summary.md
  index.json
```

### Journal file format
One Markdown file per day, with frontmatter:
- Must include at least: `date`, `timezone`
- Must contain sections: `## Inbox`, `## Notes` (or `## Notas libres` if you keep Spanish; but standardize in English for code)

Example:
```md
---
date: 2026-02-14
timezone: Europe/Andorra
sleep:
  subjective: 7
  awakenings: 2
  notes: "woke up twice"
---

## Inbox
- Coffee at 16:45
- Leg workout at ~18:00 (RPE 8)
- Dinner 22:30: pizza + beer
- Magnesium 400mg before bed

## Notes
Felt a bit wired in the evening.
```

### Derived artifacts
- `derived/YYYY-MM-DD.features.json`: structured representation for analytics/AI
- `derived/YYYY-MM-DD.summary.md`: daily summary/insights (can be generated by AI later)
- These should be **fully regenerable** from the `journal` markdown.

### Index
- `data/index.json` stores quick listing metadata (date, relative file path, updatedAt)
- Keep it minimal and robust.

---

## 3) Repository Organization (Required)
Monorepo structure:
```
apps/
  web/         # React + Vite frontend
  api/         # Express backend
  agent/       # Mastra service (phase 2+; can start empty)
packages/
  shared/      # Shared TS types, Zod schemas, utilities (frontmatter parsing, date helpers)
data/          # Local storage (journal, derived, index.json) — committed or gitignored depending on preference
```

### Policy
- `apps/api` must never assume any external DB.
- All file IO must target `repoRoot/data/...`
- Prefer keeping all “domain parsing logic” in `packages/shared` so both `api` and `agent` can reuse.

---

## 4) MVP Feature Set (Phase 1, no Mastra required)
### Backend (Express)
Implement these endpoints:

1) Health
- `GET /health` -> `{ ok: true }`

2) Index listing
- `GET /journal` -> returns `index.json` contents `{ entries: [...] }`
- If missing, return `{ entries: [] }`

3) Read day
- `GET /journal/:date` -> ensures file exists; returns `{ date, markdown }`

4) Append to day inbox
- `POST /journal/:date/append`
  - body: `{ text: string }` (multi-line allowed)
  - behavior:
    - ensure day file exists; create with template if needed
    - append each non-empty line as a bullet under `## Inbox`
    - update `index.json`
  - returns: `{ ok: true, date, appended: number }`

5) (Optional for phase 1 but recommended) Upsert sleep frontmatter
- `POST /journal/:date/sleep`
  - body: `{ subjective?: number, awakenings?: number, notes?: string }`
  - updates frontmatter safely (no destructive rewrite of content sections)

### Frontend (React)
Minimal screens:

1) Inbox entry
- Date input (defaults to today)
- Text area (multi-line)
- Submit: calls `POST /journal/:date/append`

2) Day viewer
- Display current day markdown (`GET /journal/:date`)
- Optional: show list of available days (`GET /journal`)

---

## 5) Phase 2 Feature Set (Derived Artifacts + AI-ready)
### Derived pipeline (no AI required initially)
Add endpoint:
- `POST /derive/:date`
  - reads `journal/YYYY-MM-DD.md`
  - parses frontmatter + Inbox bullet lines
  - generates `derived/YYYY-MM-DD.features.json` with basic heuristics
  - (optional) generates `derived/YYYY-MM-DD.summary.md` with template-based summary

`features.json` minimum shape:
```json
{
  "date": "YYYY-MM-DD",
  "timezone": "Europe/Andorra",
  "sleep": { "subjective": 7, "awakenings": 2 },
  "entries": [
    { "raw": "Coffee at 16:45" },
    { "raw": "Magnesium 400mg before bed" }
  ],
  "signals": {
    "caffeine": [{ "time": "16:45", "amount_mg": null }],
    "supplements": [{ "name": "magnesium", "dose": "400mg", "time": null }],
    "exercise": [{ "type": "strength", "time": "18:00", "intensity": "RPE 8" }],
    "alcohol": [{ "type": "beer", "time": "22:30" }]
  }
}
```

**Important:** In phase 2 heuristics can be simplistic; the AI agent will improve parsing later.

### Mastra integration (agent service)
Create `apps/agent` to run a Mastra workflow that:
- input: date
- reads journal markdown
- outputs:
  - structured features json
  - optional markdown summary
- writes into `data/derived/` only (default)
- logs trace info

The API can call the agent via:
- direct import (shared lib) OR
- HTTP call to agent service (prefer separate service if easy)

---

## 6) CLI Instructions (Commands to create the repo)
### Assumptions
- You are currently in the repo root.
- Bun and Node are installed.
- Use Bun as package manager; Node as runtime for Express.

### Create the monorepo
```bash
bunx create-turbo@latest .
rm -rf apps packages
mkdir -p apps/web apps/api apps/agent packages/shared
mkdir -p data/journal data/derived
```

### Root package.json (workspaces + turbo)
- Ensure:
  - `private: true`
  - `workspaces: ["apps/*","packages/*"]`
  - scripts: `dev`, `build`, `typecheck`
- Install:
```bash
bun add -D turbo typescript
```

### Web app (Vite React TS)
```bash
cd apps/web
bunx create-vite@latest . --template react-ts
bun install
cd ../..
```

### API app (Express TS)
```bash
cd apps/api
bun init -y
bun add express cors dotenv zod
bun add -D typescript tsx @types/node @types/express @types/cors
mkdir -p src
cd ../..
```

### Shared package
```bash
cd packages/shared
bun init -y
bun add zod
bun add -D typescript
mkdir -p src
cd ../..
```

### Install monorepo deps
```bash
bun install
```

### Run dev (turbo)
```bash
bun run dev
```

---

## 7) Coding Guidelines (Do this)
### Local file IO
- Always resolve paths from repo root:
  - In `apps/api`, `process.cwd()` will be `apps/api`; go up to repo root via `path.resolve(process.cwd(), "../..")`.
- Ensure directories exist (`fs.mkdir(..., { recursive: true })`)
- Use atomic-ish writes where possible (write temp then rename) if needed later.

### Markdown edits
- Never “rewrite the whole file blindly”.
- Implement safe operations:
  - Ensure template exists
  - Append bullet lines under `## Inbox`
  - Update YAML frontmatter without removing unknown keys
- Prefer a library to parse frontmatter later (e.g., `gray-matter`) **or** implement a small parser in `packages/shared`.
  - If you add a library, do it once in `packages/shared` and reuse.

### Concurrency
- Single-user local: still guard against simultaneous edits:
  - Check file `mtime` before overwriting
  - Keep updates minimal (append operations)
  - Consider a simple lock file approach if needed later

### AI safety/robustness
- AI should not silently alter source journal.
- AI output should go to `derived/` and optionally propose changes.

---

## 8) Acceptance Criteria (Definition of Done)
Phase 1 is done when:
- `POST /journal/:date/append` creates/updates `data/journal/:date.md` correctly
- `GET /journal/:date` returns the markdown
- `GET /journal` lists days from `index.json`
- Frontend can append entries and show a success message
- The repo runs with `bun run dev` (turbo) and backend is accessible

Phase 2 is done when:
- `POST /derive/:date` generates `features.json` under `data/derived/`
- Re-running derive is idempotent and overwrites derived outputs safely
- The derived outputs are usable by an agent later

---

## 9) Implementation Order (Strict)
1) Monorepo scaffolding + dev scripts working
2) Express API: health + journal read/create + append
3) Frontend: minimal inbox submit + day fetch display
4) Index maintenance (`data/index.json`)
5) Shared utilities: date helpers, safe file ops
6) Derived pipeline endpoint
7) Mastra agent skeleton (optional), then integrate parsing improvements

---

## 10) Notes for the Coding Agent
- Keep everything in TypeScript.
- Avoid introducing databases.
- Prefer small, testable functions in `packages/shared`.
- Keep endpoints stable and simple.
- Document any assumptions in code comments.
